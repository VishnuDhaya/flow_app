<?php

use App\Models\Account;
use App\Services\DataScoreModelService;
use App\Services\Factors;
use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class ReimportDeletedUmtnCustCsfValues extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up() {
		
		DB::beginTransaction();
        $data_serv = new DataScoreModelService;
        set_app_session('UGA');
		$acc_prvdr_code = 'UMTN';
        session(['acc_prvdr_code' => $acc_prvdr_code]);
		try {
            $accs_wo_commission = [];
            $deleted_acc_numbers = ['041960','050001','078276','199416','301722','301945','625055','041378','041610','046526','051944','052487','060920','061585','073980','076586','219435','079955','112672','113286','122350','192430','192750','195196','199284','256772112179','205608','213345','219078','404221','405178','405811','407633','411266','503692','505732','507966','560152','610089','610312','611078','611283','611733','616483','625557','632647','633339','633782','646452','648581','648646','649593','658627','663969','666374','670560','690217','691339','714055','730460','734436','734958','738346','752980','756009','756043','762998','774339','774340','779162','779206','50001','790474','791070','791323','791537','896783','898004','898252','902907','971072','302685','409906','89452','051692','113925','303438','751710','265479','402227','610851','635479','107756','557714','667639','776987','563739','671916','040936','538292','566051','011241','056209','194006','194994','506941','628709','670988','778938','811612','029058','054324','811493','895408','196070','690566','813318','195022','114393','759858','950610','406972','566744','790767','405849','773463','895733','025309','503538','772917','789654','791225','741588','624155','792132','918453','565259','791339','813381','768916','997919','672301','128179','502156','302170','690841','060367','736875','669369','056049','748605','504755','302796','634176','055930','737148','774835','811331','898778','210863','892350','623421','670216','192936','209901','620420','622245','627394','102497','673703','633509','779412','813296','692351','078442','090751','040946','411233','103878','572063','502945','768223','774958','730861','211546','736477','745726','611812','820214','940123','607799','634305','063891','791313','205880','671629','113520','106651','192251','118114','762304','600133','300782','726169','669477','768266','629109','896971','120011','101997','404870','734930','610909','663256','612015','648390','107060','895981','178452','726209','627960','123339','410248','792084','508500','195755','663594','508025','808281','079506','690460','625223','806786','407081','120050','734967','190635','932259','610711','995462','745250','117453','303098','568282','662760','193324','756168','566539','611053','198131','894884','116889','728395','649122','112296','064058','773288','631070','622835','759928','650723','218069','193893','192515','753089','613922','115771','773224','407850','564322','950952','123497','896816','052017','667622','195115','216436','628873','759532','621762','200311','621801','766318','193189','730133','665321','754948','760386','671925','892946','900215','807584','768237','202026','648371','091521','610091','700256','767946','620412','756151','757244','612360','410236','752308','610098','723494','404702','630038','564839','077771','789601','805726','913921','208897','620019','673881','213047','042863','723955','819728','711678','666366','914382','078387','203870','621757','120902','407412','807076','962875','749852','738026','090133','961825','820007','919778','725945','198661','206989','813916','714448','762824','647693','666359','963734','612352','255395','608637','763126','063892','767477','042752','074716','651714','962580','204909','091377','792979','789328','799205','730772','981550','613261','758634','567467','625991','127708','403769','198878','713172','919106','039592','889255','809954','504021','775314','770039','200601','773079','734993','600131','762268','796834','621350','758941','632004','897916','670247','739309','504340','751377','566803','105285','213648','635383','773665','107894','191385','714484','626141','944820','613257','565385','232123','503572','042437','618860','218773','120809','919252','619397','100727','806944','017313','571991','124081','665691','508340','738733','655599','894420','750351','105891','670047','772667','913437','214396','611328','634196','623019','912249','302584','901046','211255','899649','612732','046420','815556','997258','194207','631626','202399','771652','750468','117195','290418','791586','559790','670948','771070','091483','621463','765864','404673','612815','773278','985788','840166','194437','332154','565641','817802','126407','047701','739301','403650','818989','611452','750502','674559','164482','627617','760457','610894','557540','917096','570037','587248','560667','805727','913621','788309','913914','749647','090119','049562','218511','808789','757495','662850','749846','203938','691996','123605','942105','623325','762416','766250','654955','121002','122284','738110','745727','600701','117291','962934','806913','054449','635825','663414','632091','406395','772138','737474','324906','403044','114743','737412','115413','075294','300135','505942','789802','692142','888624','402867','733308','999988','773057','055999','505820','755744','776764','623598','405865','760642','805046','773380','811765','206296','763147','753816','690494','736250','629609','629153','807302','733265','911829','044120','620861','195744','208203','773386','755187','919868','031904','630789','795780','800982','407913','039704','180223','736706','792201','701986','265055','713466','648257','120014','633400','055361','919299','610134','805824','628746','670196','823340','196783','568204','757762','736567','772162','753081','117614','626752','805269','610263','734217','953662','054730','823080','119090','073886','663925','114852','825878','774786','612689','107364','406849','043657','628000','200657','984111','670819','919187','768707','895572','621483','813955','062162','895328','911278','633043','201722','736010','406565','507179','040639','502129','072924','950397','700985','389872','751295','723138','893021','805974','120801','626187','692078','963676','053816','702430','777100','768192','630026','721922','206069','763772','051459','633643','071222','612133','202234','569509','673177','888848','300993','702589','712955','736131','667306','737987','912228','218197','713721','761741','216982','039142','897651','724976','618569','608143','620293','911753','126329','767673','107670','917605','899613','779521','713572','667959','738400','713503','664135','218849','981405','777436','763473','665104','816000','729000','613847','214633','793013','202765','960085','723871','963491','845870','897826','215270','912783','051862','128284','733033','790321','667971','506151','724309','409695','202594','052908','612138','805232','776061','897484','401524','750358','944584','102182','751351','895165','797535','663692','996156','666087','612300','499815','560513','078647','621226','751380','953777','621501','713256','406247','208195','805659','669223','562197','209019','712589','506458','664968','760982','218980','961570','116250','714195','619667','962261','106155','820107','815640','564426','896516','207964','878813','077069','806780','896129','560890','301664','665953','646932','669343','745533','724261','759471','726553','730090','766615','738805','623610','212665','699855','840801','778021','911895','627217','618550','712831','724043','753646','619369','991331','756309','759203','767752','756278','941882','019395','561478','978454','506744','571987','570312','611059','196755','631098','623639','792809','912013','365656','670394','953841','112365','775528','777814','950026','892514','670326','769029','911956','942143','622004','920039','807323','840405','889321','651347','630585','544918','611546','821504','090332','103137','209707','030066','813779','779501','106706','193577','050805','506288','622883','219362','310767','912102','701166','611661','714488','917532','995556','985864','106264','557280','409835','736675','075068','721615','692115','700283','673847','819373','627040','198474','205337','663077','505644','758033','790660','896415','301672','610626','666469','627856','757418','510251','920778','762967','896267','736698','752451','567204','749668','672653','115002','079850','123773','893851','303032','662619','909045','073548','572131','948488','690650','985653','757661','190121','611592','762432','622203','984142','912549','817166','570752','625397','912005','723292','756643','654992','982103','505191','759308','714585','713822','942500','570821','813753','817357','911152','651375','776906','750081','756047','725721','627198','629057','654578','691706','624242','566427','771306','817786','612775','635150','763990','611224','619749','919156','627847','651099','663234','817861','077737','745534','600416','218375','997110','912462','611508','776787','645417','502701','646576','649868','411457','894875','962675','623817','209637','633255','053918','632420','626263','112095','567686','619444','621719','750023','779270','777805','721894','913969','550278','760001','771216','208392','723448','626829','508199','670496','778828','608553','619218','625156','651526','628657','623746','609402','778927','812942','894759','627296','155326','626158','670767','962035','777244','120425','077203','649807','407733','745801','771231','981726','621937','811124','918912','211885','735912','650131','611091','076701','997408','069476','108539','713798','911029','723443','896182','757697','610797','900666','571112','788201','962617','758497','195211','504713','647499','665528','613826','611061','067119','074406','773257','125001','206228','648425','800891','625067','662636','646632','612325','629435','613646','302163','773276','611222','016002','612474','756455','216820','403987','115405','610705','825740'];
            
            foreach ( $deleted_acc_numbers as $acc_number) {
                $customer_details = $data_serv->get_scoring_model($acc_number);
                $comms = $data_serv->get_last_N_comms($acc_number, session('acc_prvdr_code'), 3);
                if(!empty($comms)) {
                    $max_comms = max($comms);
                
                    $factors = Factors::normalize($acc_number, session('country_code'), ['monthly_comms' => $max_comms]);
                    $factors = json_decode(json_encode($factors), true);

                    $customer_data = [
                        "country_code" => session('country_code'),
                        "acc_number" => $acc_number,
                        "acc_prvdr_code" => session('acc_prvdr_code'),
                        "run_id" => uniqid(),
                        "score_model" => "comm_only_model",
                        "customer_details" => $customer_details,
                        "cust_score_factors" => $factors
                    ];
                    $data_serv->calculate_score_and_insert_csf_values($customer_data);
                }
                else {
					$account_id = $customer_details['account_id'];
                    if($account_id) {
					    $account = (new Account)->find($account_id, ['acc_number', 'cust_id', 'acc_prvdr_code', 'alt_acc_num', 'holder_name']);
                    }
					else {
                        $account = new stdClass();
						$account->cust_id = null;
						$account->acc_prvdr_code = $acc_prvdr_code;
						$account->acc_number = $acc_number;
						$account->alt_acc_num = null;
						$account->holder_name = null;
					}
					$accs_wo_commission[] = $account;
                }
            }
			if ( count($accs_wo_commission) > 0) {
				$mail_data = ['country_code' => session('country_code'), 'accounts' => $accs_wo_commission, 'acc_prvdr_code' => session('acc_prvdr_code')];
				send_email('missing_comms_notification', config('app.ops_auditor_email'), $mail_data);
			}
            DB::commit();
        }
        catch(Exception $e) {
            DB::rollback();
            thrw($e->getMessage());
        }
	}

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        //
    }
}
